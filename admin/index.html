<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¾Œå°ç®¡ç† â€¢ SusanLifeShare</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    :root{color-scheme:dark;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:#0b0c10;color:#f2f4f8}
    a{color:inherit}
    .wrap{max-width:1280px;margin:0 auto;padding:16px}
    .topbar{position:sticky;top:0;z-index:50;background:rgba(11,12,16,.85);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.08)}
    .topbar .wrap{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0;font-size:16px}
    .sub{opacity:.75;font-size:12px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#f2f4f8;font-weight:700;font-size:13px;cursor:pointer;text-decoration:none;user-select:none}
    .btn.primary{background:rgba(125,92,255,.22);border-color:rgba(125,92,255,.5)}
    .btn.danger{background:rgba(255,80,80,.14);border-color:rgba(255,80,80,.35)}
    .btn.small{padding:8px 10px;font-size:12px;border-radius:10px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .card{border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);border-radius:16px;padding:14px}
    .grid{display:grid;grid-template-columns:1.4fr .9fr;gap:12px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    input,select,textarea{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color:#f2f4f8;border-radius:12px;
      padding:10px 12px;font-size:13px;outline:none;
    }
    textarea{width:100%;min-height:190px;resize:vertical;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .muted{opacity:.75;font-size:12px}
    .titleline{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:10px}
    .tablewrap{overflow:auto;border-radius:14px;border:1px solid rgba(255,255,255,.08)}
    table{width:100%;border-collapse:collapse;min-width:980px;background:rgba(0,0,0,.12)}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.06);vertical-align:top}
    th{font-size:12px;opacity:.8;text-align:left;background:rgba(255,255,255,.03);position:sticky;top:0}
    td .cell{width:100%}
    .cell input,.cell select{width:100%}
    .tiny{font-size:11px;opacity:.78}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);font-size:12px}
    .chiplist{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .chip{display:flex;gap:8px;align-items:center;padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.05)}
    .chip input{padding:6px 10px;border-radius:999px}
    .sep{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
    .rightBtns{display:flex;gap:10px;flex-wrap:wrap}
    .note{margin-top:10px;font-size:12px;opacity:.78;line-height:1.5}
    .ok{color:#76ff9a}
    .warn{color:#ffcf5c}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="wrap">
      <div>
        <h1>å¾Œå°ç®¡ç† â€¢ SusanLifeShare</h1>
        <div class="sub">ï¼ˆå»ºè­°ç”¨ Cloudflare Access ä¿è­· /admin/*ï¼Œä¸è¦ç”¨ Basic Auth å½ˆçª—ï¼‰</div>
      </div>
      <div class="rightBtns">
        <a class="btn" href="../" target="_blank" rel="noopener">Back to site</a>
        <button class="btn primary" id="btnSaveLocal">Save (Local)</button>
        <button class="btn" id="btnLoadLocal">Load (Local)</button>
        <button class="btn" id="btnReset">Reset to JSON</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">

      <!-- LEFT: Items -->
      <div class="card">
        <div class="titleline">
          <div>
            <div class="pill">å½±ç‰‡ç®¡ç†ï¼ˆç›´æ¥è¡¨æ ¼ç·¨è¼¯ï¼Œä¸è·³æ¡†ï¼‰</div>
            <div class="muted">âœ… å‹¾é¸å¯æ‰¹é‡ç§»å‹•åˆ†é¡ / æ‰¹é‡åˆªé™¤ï¼›âœ… æ”¯æ´è²¼ä¸Š / ä¸Šå‚³ TXT æ‰¹é‡åŒ¯å…¥</div>
          </div>
          <div class="row">
            <button class="btn small" id="btnAddRow">ï¼‹æ–°å¢ä¸€åˆ—</button>
            <button class="btn small danger" id="btnDeleteSelected">æ‰¹é‡åˆªé™¤</button>
          </div>
        </div>

        <div class="row">
          <select id="bulkCat" class="cell"></select>
          <button class="btn small" id="btnBulkMove">æ‰¹é‡ç§»å‹•åˆ†é¡</button>
          <div class="muted">åˆ†é¡å¯ç•™ç©ºï¼ä¸åˆ†é¡ï¼ˆå‰å°å¯éš±è—åˆ†é¡åˆ—ï¼‰</div>
        </div>

        <div class="sep"></div>

        <div class="tablewrap">
          <table>
            <thead>
              <tr>
                <th style="width:44px"><input type="checkbox" id="ckAll" /></th>
                <th style="width:180px">æ¨™é¡Œ</th>
                <th style="width:260px">ç¶²å€ URL</th>
                <th style="width:140px">åˆ†é¡</th>
                <th style="width:120px">Tag</th>
                <th style="width:90px">Hot</th>
                <th style="width:130px">æ—¥æœŸ</th>
                <th style="width:220px">ç¸®åœ–(å¯ç©º)</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="note">
          <div>ğŸŸ¢ <b class="ok">æœ€å¿«å·¥ä½œæµç¨‹</b>ï¼šæ”¹å®Œ â†’ å³é‚Š <b>Export JSON</b> / <b>Download videos.json</b> â†’ è¦†è“‹ repo çš„ <code>data/videos.json</code> â†’ Commitã€‚</div>
          <div>ğŸŸ¡ è¦ã€ŒæŒ‰ä¿å­˜å°±è‡ªå‹•å¯«å…¥ã€ï¼šè¦æ”¹æˆ <b>D1 + API</b>ï¼ˆæˆ‘å¯ä»¥ä¸‹ä¸€æ­¥ç›´æ¥çµ¦ä½ æ•´å¥—ï¼‰ã€‚</div>
        </div>
      </div>

      <!-- RIGHT: Categories + Import/Export -->
      <div class="card">
        <div class="titleline">
          <div>
            <div class="pill">åˆ†é¡ç®¡ç†ï¼ˆå¯æ–°å¢ / é‡æ–°å‘½å / åˆªé™¤ï¼‰</div>
            <div class="muted">åˆªé™¤åˆ†é¡æœƒæŠŠè©²åˆ†é¡å½±ç‰‡æ”¹æˆã€Œä¸åˆ†é¡ã€</div>
          </div>
        </div>

        <div class="row">
          <input id="newCat" placeholder="æ–°å¢åˆ†é¡åç¨±ï¼ˆä¾‹å¦‚ Life / Travel / Fitnessï¼‰" class="cell" />
          <button class="btn small" id="btnAddCat">ï¼‹æ–°å¢</button>
        </div>

        <div class="chiplist" id="catList"></div>

        <div class="sep"></div>

        <div class="pill">æ‰¹é‡åŒ¯å…¥ï¼ˆè²¼ä¸Šæˆ–ä¸Šå‚³ TXT / CSVï¼‰</div>
        <div class="muted">æ¯è¡Œä¸€ç­†ï¼Œæ”¯æ´æ ¼å¼ï¼š</div>
        <div class="tiny">
          1) åªæœ‰ URLï¼š<code>https://....</code><br/>
          2) ç”¨ | åˆ†éš”ï¼š<code>æ¨™é¡Œ | URL | tag | åˆ†é¡</code><br/>
          3) ç”¨ , åˆ†éš”ï¼š<code>æ¨™é¡Œ,URL,tag,åˆ†é¡</code>
        </div>

        <div style="margin-top:10px" class="row">
          <input type="file" id="fileImport" accept=".txt,.csv" />
          <button class="btn small" id="btnApplyImport">å¥—ç”¨åŒ¯å…¥</button>
        </div>
        <textarea id="importBox" placeholder="æŠŠä¸€å †ç¶²å€è²¼åœ¨é€™è£¡ï¼ˆæ¯è¡Œä¸€å€‹ï¼‰&#10;ä¾‹å¦‚ï¼š&#10;https://vinovo.to/...&#10;æ¨™é¡Œ | https://... | rescue | Animals"></textarea>
        <div class="muted" id="importHint">å°šæœªåŒ¯å…¥</div>

        <div class="sep"></div>

        <div class="pill">JSON åŒ¯å…¥ / åŒ¯å‡ºï¼ˆçµ¦ä½ å‚™ä»½ç”¨ï¼‰</div>
        <div class="row" style="margin-top:10px">
          <button class="btn small" id="btnExport">Export JSONï¼ˆè¤‡è£½ï¼‰</button>
          <button class="btn small" id="btnDownload">Download videos.json</button>
          <button class="btn small" id="btnImportJSON">Import JSONï¼ˆå¥—ç”¨ä¸‹æ–¹ï¼‰</button>
        </div>
        <textarea id="jsonBox" placeholder='{"categories":[...],"items":[...]}'></textarea>
        <div class="muted">æç¤ºï¼šä½ ä¹Ÿå¯ä»¥æŠŠ repo çš„ <code>data/videos.json</code> å…§å®¹æ•´æ®µè²¼é€²ä¾†ä¿®æ”¹ã€‚</div>
      </div>

    </div>
  </div>

<script>
  // ------------------------
  // Data model
  // ------------------------
  const todayISO = () => new Date().toISOString().slice(0,10);
  const uid = () => "id_" + Math.random().toString(36).slice(2,10) + Date.now().toString(36);

  let db = { categories: [], items: [] };

  const el = (id) => document.getElementById(id);
  const tbody = el("tbody");
  const catList = el("catList");

  function normCat(c){ return (c||"").trim(); }

  function rebuildSelectOptions(){
    // bulk category select + each row category select
    const cats = ["(ä¸åˆ†é¡)"].concat(db.categories);
    const bulk = el("bulkCat");
    bulk.innerHTML = cats.map((c,i)=>{
      const v = i===0 ? "" : c;
      const t = i===0 ? "(No category)" : c;
      return `<option value="${escapeHtml(v)}">${escapeHtml(t)}</option>`;
    }).join("");
  }

  function escapeHtml(s){
    return (s+"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function renderCategories(){
    catList.innerHTML = "";
    if (!db.categories.length){
      const d = document.createElement("div");
      d.className="muted";
      d.textContent="ï¼ˆç›®å‰æ²’æœ‰åˆ†é¡ï¼šç­‰æ–¼ä¸åˆ†é¡æ¨¡å¼ï¼‰";
      catList.appendChild(d);
      return;
    }

    db.categories.forEach((c) => {
      const chip = document.createElement("div");
      chip.className="chip";
      chip.innerHTML = `
        <span class="tiny">åˆ†é¡</span>
        <input value="${escapeHtml(c)}" data-old="${escapeHtml(c)}" />
        <button class="btn small" data-act="rename">æ”¹å</button>
        <button class="btn small danger" data-act="delete">åˆªé™¤</button>
      `;
      chip.querySelector('[data-act="rename"]').onclick = () => {
        const inp = chip.querySelector("input");
        const oldName = inp.dataset.old;
        const newName = normCat(inp.value);
        if (!newName) return alert("åˆ†é¡åç¨±ä¸èƒ½ç©ºç™½");
        if (oldName === newName) return;
        if (db.categories.includes(newName)) return alert("å·²æœ‰åŒååˆ†é¡");

        db.categories = db.categories.map(x => x===oldName ? newName : x);
        db.items.forEach(it => { if (it.cat === oldName) it.cat = newName; });
        renderAll();
      };

      chip.querySelector('[data-act="delete"]').onclick = () => {
        const oldName = chip.querySelector("input").dataset.old;
        if (!confirm(`ç¢ºå®šåˆªé™¤åˆ†é¡ã€Œ${oldName}ã€ï¼Ÿ\nè©²åˆ†é¡å½±ç‰‡æœƒè®Šæˆä¸åˆ†é¡ã€‚`)) return;
        db.categories = db.categories.filter(x => x!==oldName);
        db.items.forEach(it => { if (it.cat === oldName) it.cat = ""; });
        renderAll();
      };

      catList.appendChild(chip);
    });
  }

  function rowHTML(it){
    const catOptions = [`<option value="">(ä¸åˆ†é¡)</option>`]
      .concat(db.categories.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`))
      .join("");

    return `
      <tr data-id="${escapeHtml(it.id)}">
        <td><input type="checkbox" class="ckRow" /></td>
        <td><div class="cell"><input class="inpTitle" value="${escapeHtml(it.title||"")}" placeholder="å¯ç©ºï¼ˆä½ ä¹Ÿå¯å…ˆä¸å¡«ï¼‰"/></div></td>
        <td><div class="cell"><input class="inpUrl" value="${escapeHtml(it.url||"")}" placeholder="è²¼å½±ç‰‡ç¶²å€" /></div></td>
        <td><div class="cell">
          <select class="selCat">${catOptions}</select>
        </div></td>
        <td><div class="cell"><input class="inpTag" value="${escapeHtml(it.tag||"")}" placeholder="ä¾‹å¦‚ vlog / rescue" /></div></td>
        <td><div class="cell"><input class="inpHot" type="number" min="0" max="999" value="${escapeHtml(it.hot ?? 0)}" /></div></td>
        <td><div class="cell"><input class="inpDate" type="date" value="${escapeHtml(it.date||todayISO())}" /></div></td>
        <td><div class="cell"><input class="inpThumb" value="${escapeHtml(it.thumb||"")}" placeholder="å¯ç©ºï¼šå‰å°ç”¨é è¨­" /></div></td>
      </tr>
    `;
  }

  function bindRowEvents(tr, it){
    const selCat = tr.querySelector(".selCat");
    selCat.value = it.cat || "";

    const sync = () => {
      it.title = tr.querySelector(".inpTitle").value.trim();
      it.url   = tr.querySelector(".inpUrl").value.trim();
      it.cat   = normCat(tr.querySelector(".selCat").value);
      it.tag   = tr.querySelector(".inpTag").value.trim();
      it.hot   = Number(tr.querySelector(".inpHot").value || 0);
      it.date  = tr.querySelector(".inpDate").value || todayISO();
      it.thumb = tr.querySelector(".inpThumb").value.trim();
      updateJSONBox();
    };

    tr.querySelectorAll("input,select").forEach(x=>{
      x.addEventListener("input", sync);
      x.addEventListener("change", sync);
    });
  }

  function renderTable(){
    tbody.innerHTML = db.items.map(rowHTML).join("");
    [...tbody.querySelectorAll("tr")].forEach(tr=>{
      const id = tr.dataset.id;
      const it = db.items.find(x=>x.id===id);
      if (it) bindRowEvents(tr, it);
    });
    updateJSONBox();
  }

  function renderAll(){
    rebuildSelectOptions();
    renderCategories();
    renderTable();
  }

  function updateJSONBox(){
    el("jsonBox").value = JSON.stringify(db, null, 2);
  }

  // ------------------------
  // Load initial data
  // ------------------------
  async function loadFromServer(){
    try{
      const res = await fetch("../data/videos.json", {cache:"no-store"});
      if (!res.ok) throw new Error("no data/videos.json");
      const j = await res.json();
      db = {
        categories: Array.isArray(j.categories) ? j.categories.map(normCat).filter(Boolean) : [],
        items: Array.isArray(j.items) ? j.items.map(x=>({
          id: x.id || uid(),
          title: x.title||"",
          url: x.url||"",
          thumb: x.thumb||"",
          cat: normCat(x.cat||""),
          tag: x.tag||"",
          hot: Number(x.hot||0),
          date: x.date||todayISO()
        })) : []
      };
      renderAll();
    }catch(e){
      db = { categories: [], items: [] };
      renderAll();
      updateJSONBox();
    }
  }

  // ------------------------
  // Buttons
  // ------------------------
  el("btnAddRow").onclick = () => {
    db.items.unshift({id:uid(), title:"", url:"", thumb:"", cat:"", tag:"", hot:0, date:todayISO()});
    renderTable();
  };

  el("ckAll").onclick = (e) => {
    const on = e.target.checked;
    document.querySelectorAll(".ckRow").forEach(x=>x.checked = on);
  };

  function selectedIds(){
    const ids = [];
    document.querySelectorAll("#tbody tr").forEach(tr=>{
      const ck = tr.querySelector(".ckRow");
      if (ck && ck.checked) ids.push(tr.dataset.id);
    });
    return ids;
  }

  el("btnDeleteSelected").onclick = () => {
    const ids = selectedIds();
    if (!ids.length) return alert("è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„å½±ç‰‡");
    if (!confirm(`ç¢ºå®šåˆªé™¤ ${ids.length} ç­†ï¼Ÿ`)) return;
    db.items = db.items.filter(x=>!ids.includes(x.id));
    renderTable();
  };

  el("btnBulkMove").onclick = () => {
    const ids = selectedIds();
    if (!ids.length) return alert("è«‹å…ˆå‹¾é¸è¦ç§»å‹•çš„å½±ç‰‡");
    const to = normCat(el("bulkCat").value);
    db.items.forEach(it=>{ if (ids.includes(it.id)) it.cat = to; });
    renderTable();
  };

  el("btnAddCat").onclick = () => {
    const c = normCat(el("newCat").value);
    if (!c) return alert("è«‹è¼¸å…¥åˆ†é¡åç¨±");
    if (db.categories.includes(c)) return alert("å·²æœ‰åŒååˆ†é¡");
    db.categories.push(c);
    el("newCat").value = "";
    renderAll();
  };

  el("btnSaveLocal").onclick = () => {
    localStorage.setItem("SLS_DB_LOCAL", JSON.stringify(db));
    alert("å·²å­˜åˆ°æœ¬æ©Ÿ LocalStorageï¼ˆåªæœ‰ä½ é€™å°/é€™å€‹ç€è¦½å™¨çœ‹å¾—åˆ°ï¼‰");
  };

  el("btnLoadLocal").onclick = () => {
    const s = localStorage.getItem("SLS_DB_LOCAL");
    if (!s) return alert("æœ¬æ©Ÿæ²’æœ‰å­˜æª”");
    try{
      const j = JSON.parse(s);
      db = {
        categories: Array.isArray(j.categories) ? j.categories.map(normCat).filter(Boolean) : [],
        items: Array.isArray(j.items) ? j.items : []
      };
      renderAll();
      alert("å·²è¼‰å…¥æœ¬æ©Ÿå­˜æª”");
    }catch(e){
      alert("æœ¬æ©Ÿå­˜æª”å£æ‰äº†");
    }
  };

  el("btnReset").onclick = () => {
    if (!confirm("ç¢ºå®šè¦ç”¨ä¸‹æ–¹ JSON è¦†è“‹ç›®å‰è³‡æ–™ï¼Ÿ")) return;
    try{
      const j = JSON.parse(el("jsonBox").value || "{}");
      db = {
        categories: Array.isArray(j.categories) ? j.categories.map(normCat).filter(Boolean) : [],
        items: Array.isArray(j.items) ? j.items : []
      };
      renderAll();
    }catch(e){
      alert("JSON è§£æå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ ¼å¼");
    }
  };

  el("btnExport").onclick = async () => {
    const txt = JSON.stringify(db, null, 2);
    try{
      await navigator.clipboard.writeText(txt);
      alert("å·²è¤‡è£½ JSON åˆ°å‰ªè²¼ç°¿");
    }catch(e){
      alert("è¤‡è£½å¤±æ•—ï¼ˆç€è¦½å™¨é™åˆ¶ï¼‰ï¼Œè«‹æ‰‹å‹•å…¨é¸ JSONBox è¤‡è£½");
    }
  };

  el("btnDownload").onclick = () => {
    const blob = new Blob([JSON.stringify(db, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "videos.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 500);
  };

  el("btnImportJSON").onclick = () => {
    try{
      const j = JSON.parse(el("jsonBox").value || "{}");
      db = {
        categories: Array.isArray(j.categories) ? j.categories.map(normCat).filter(Boolean) : [],
        items: Array.isArray(j.items) ? j.items : []
      };
      renderAll();
      alert("å·²å¥—ç”¨ JSON");
    }catch(e){
      alert("JSON è§£æå¤±æ•—");
    }
  };

  // ------------------------
  // Bulk import (paste / file)
  // ------------------------
  function parseLines(text){
    const lines = (text||"").split(/\r?\n/).map(x=>x.trim()).filter(x=>x && !x.startsWith("#"));
    const out = [];
    for (const line of lines){
      let parts = null;
      if (line.includes("|")) parts = line.split("|").map(x=>x.trim());
      else if (line.includes(",")) parts = line.split(",").map(x=>x.trim());

      if (!parts){
        // URL only
        out.push({title:"", url:line, tag:"", cat:""});
      } else {
        const [t,u,tag,cat] = parts;
        const url = (u||"").trim();
        if (!url) continue;
        out.push({title:(t||"").trim(), url, tag:(tag||"").trim(), cat:normCat(cat||"")});
      }
    }
    return out;
  }

  function applyImport(text){
    const rows = parseLines(text);
    if (!rows.length) return {added:0};
    const now = todayISO();

    // auto create categories if provided in import
    rows.forEach(r=>{
      if (r.cat && !db.categories.includes(r.cat)) db.categories.push(r.cat);
    });

    const added = [];
    rows.forEach(r=>{
      added.push({
        id: uid(),
        title: r.title || "",
        url: r.url,
        thumb: "",
        cat: r.cat || "",
        tag: r.tag || "",
        hot: 0,
        date: now
      });
    });

    // put on top
    db.items = added.concat(db.items);
    renderAll();
    return {added: added.length};
  }

  el("btnApplyImport").onclick = () => {
    const txt = el("importBox").value || "";
    const {added} = applyImport(txt);
    el("importHint").textContent = added ? `âœ… å·²åŒ¯å…¥ ${added} ç­†` : "âš ï¸ æ²’æœ‰å¯åŒ¯å…¥å…§å®¹";
  };

  el("fileImport").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if (!f) return;
    const text = await f.text();
    el("importBox").value = text;
    el("importHint").textContent = `å·²è¼‰å…¥æª”æ¡ˆï¼š${f.name}ï¼ˆæŒ‰ã€Œå¥—ç”¨åŒ¯å…¥ã€ï¼‰`;
  });

  // Init
  loadFromServer();
</script>
</body>
</html>
